"""
Product Category Classifier for PromoBG
========================================
Classifies products into categories to prevent cross-category matching disasters.

Author: Cookie
Date: 2026-02-15
"""

import re
from typing import Tuple

# Category patterns (Bulgarian + English keywords)
# Order matters for some - more specific patterns first
CATEGORY_PATTERNS = {
    'food_dairy': [
        '–º–ª—è–∫–æ', '–º–ª–µ—á–Ω', '—Å–∏—Ä–µ–Ω–µ', '–∫–∞—à–∫–∞–≤–∞–ª', '–∫—Ä–∞–≤–µ –º–∞—Å–ª–æ', '–π–æ–≥—É—Ä—Ç', 
        '–∫–∏—Å–µ–ª–æ', '–∏–∑–≤–∞—Ä–∞', '—Å–º–µ—Ç–∞–Ω–∞', 'butter', 'milk', 'cheese', 'yogurt',
        'dairy', '–º–æ—Ü–∞—Ä–µ–ª–∞', '–ø–∞—Ä–º–µ–∑–∞–Ω', '–±—Ä–∏', '–∫–∞–º–∞–º–±–µ—Ä', '—Ä–∏–∫–æ—Ç–∞', '–º–∞—Å–∫–∞—Ä–ø–æ–Ω–µ',
    ],
    'food_meat': [
        '–º–µ—Å–æ', '–∫–∞–π–º–∞', '—à—É–Ω–∫–∞', '—Å–∞–ª–∞–º', '–∫—Ä–µ–Ω–≤–∏—Ä—à', '–Ω–∞–¥–µ–Ω–∏—Ü–∞', '–±–µ–∫–æ–Ω',
        '—Å–≤–∏–Ω—Å–∫', '–ø–∏–ª–µ—à–∫', '—Ç–µ–ª–µ—à–∫', '–∞–≥–Ω–µ—à–∫', '–≥–æ–≤–µ–∂–¥', '–±—É—Ç', '–ø–ª–µ—à–∫–∞', 
        '–∫–∞—Ä–µ', '–∫—é—Ñ—Ç–µ', '–∫–µ–±–∞–ø—á–µ', '—Ñ–∏–ª–µ', '—Å—Ç–µ–∫', '—à–Ω–∏—Ü–µ–ª', '—Ä–æ–ª–µ',
        'meat', 'pork', 'chicken', 'beef', 'ham', 'sausage', 'bacon',
        '–ø—É–µ—à–∫', '–ø–∞—Ç–µ—à–∫', '–∑–∞–µ—à–∫', '—Å—å–æ–º–≥–∞', '—Ä–∏–±–∞', '—Å–∫—É–º—Ä–∏—è', '–ø—ä—Å—Ç—ä—Ä–≤–∞',
        '–ø–µ–ø–µ—Ä–æ–Ω–∏', 'pepperoni', '–∫–æ–ª–±–∞—Å', '–ª—É–∫–∞–Ω–∫–∞', '—Å—É–¥–∂—É–∫', '–µ–ª–µ–Ω–∞',
        '–º–∏–Ω—Ç–∞–π', '—Ö–µ—Ä–∏–Ω–≥–∞', '—Å–∞—Ä–¥–∏–Ω', '—Ç–æ–Ω', '—Å–∫–∞—Ä–∏–¥',
    ],
    'food_bakery': [
        '—Ö–ª—è–±', '–ø–∏—Ç–∫–∞', '–∫–∏—Ñ–ª', '–±–∞–Ω–∏—Ü–∞', '–±—É—Ö—Ç', '–∫—Ä–æ–∞—Å–∞–Ω', '–∑–µ–º–µ–ª', 
        '—Ñ—Ä–∞–Ω–∑–µ–ª–∞', '–∫–æ–∑—É–Ω–∞–∫', '—Ç–æ—Ä—Ç–∞', '—Å–ª–∞–¥–∫–∏—à', '–µ–∫–ª–µ—Ä', '–¥–æ–Ω—ä—Ç', '–ø–∞—Å—Ç–∞',
        'bread', 'pastry', 'cake', 'croissant', 'bakery', '—Ç–∞—Ä—Ç–∞', '—Ä—É–ª–æ',
        '–º—ä—Ñ–∏–Ω', '–±—Ä–µ—Ü–µ–ª', '—Ç–µ—Å—Ç–æ', '–∫–æ—Ä–∏', '—Ç–æ—Ä—Ç–∏–ª–∞', 'tortilla', '–ø–∏—Ç–∫–∏',
        '—á–∞–±–∞—Ç–∞', '—Ñ–æ–∫–∞—á–∞', '–±–∞–≥–µ—Ç',
    ],
    'food_drinks': [
        '–Ω–∞–ø–∏—Ç–∫–∞', '—Å–æ–∫', '–≤–æ–¥–∞ –º–∏–Ω–µ—Ä–∞–ª–Ω–∞', '–∫–æ–ª–∞', '–ø–µ–ø—Å–∏', '—Ñ–∞–Ω—Ç–∞', '–±–∏—Ä–∞',
        '–≤–∏–Ω–æ', '–≤–æ–¥–∫–∞', '—É–∏—Å–∫–∏', '—Ä–∞–∫–∏—è', '–ª–∏–∫—å–æ—Ä', '–¥–∂–∏–Ω', '—Ä–æ–º', '–∫–æ–Ω—è–∫',
        '—à–∞–º–ø–∞–Ω—Å–∫–æ', '–±–µ–∑–∞–ª–∫–æ—Ö–æ–ª–Ω', '–≥–∞–∑–∏—Ä–∞–Ω', '–µ–Ω–µ—Ä–≥–∏–π–Ω', '–∫–∞—Ñ–µ', '—á–∞–π',
        'coca', 'pepsi', 'sprite', 'fanta', 'beer', 'wine', 'whisky', 'vodka',
        'juice', 'drink', 'redbull', 'monster', '—É–∑–æ', '–º–∞—Å—Ç–∏–∫–∞', '—Ç–µ–∫–∏–ª–∞',
        'nescafe', 'jacobs', 'lavazza', '–ª–∏–º–æ–Ω–∞–¥–∞', '–∞–π—Ä—è–Ω',
    ],
    'food_snacks': [
        '—à–æ–∫–æ–ª–∞–¥', '–±–æ–Ω–±–æ–Ω', '–≤–∞—Ñ–ª', '–±–∏—Å–∫–≤–∏—Ç', '—á–∏–ø—Å', '–∫—Ä–µ–∫–µ—Ä', '–ª–æ–∫—É–º',
        '–¥—ä–≤–∫', '–∂–µ–ª–∏—Ä–∞–Ω', '–ø—É–¥–∏–Ω–≥', '—Å–Ω–∞–∫—Å', '–≥–æ—Ñ—Ä–µ—Ç',
        'candy', 'chocolate', 'wafer', 'biscuit', 'chips', 'snack',
        'merci', 'milka', 'nestle', 'raffaello', 'ferrero', 'twix', 'mars',
        'snickers', 'bounty', 'kitkat', 'oreo', '–ø—Ä–∏–Ω—Ü', '–¥–µ–ª–∏—á–µ',
        '–ø—É–∫–∞–Ω–∫', '—Å–æ–ª–µ—Ç–∏', '–∫—Ä–µ–º —à–æ–∫–æ–ª–∞–¥', '–Ω—É—Ç–µ–ª–∞',
    ],
    'food_frozen': [
        '–∑–∞–º—Ä–∞–∑–µ–Ω', '—Å–ª–∞–¥–æ–ª–µ–¥', 'frozen', 'ice cream', '–ª–µ–¥–µ–Ω', '–∑–∞–º—Ä–∞–∑–µ–Ω–∞ –ø–∏—Ü–∞',
    ],
    'food_pantry': [
        '–æ—Ä–∏–∑', '–º–∞–∫–∞—Ä–æ–Ω', '—Å–ø–∞–≥–µ—Ç–∏', '–æ–ª–∏–æ', '–æ—Ü–µ—Ç', '–∑–∞—Ö–∞—Ä', '–±—Ä–∞—à–Ω–æ', 
        '—Å–æ–ª', '–ø–æ–¥–ø—Ä–∞–≤–∫', '–∫–æ–Ω—Å–µ—Ä–≤', '–∑–µ—Ö—Ç–∏–Ω', '—Å–æ—Å', '–∫–µ—Ç—á—É–ø', '–º–∞–π–æ–Ω–µ–∑–∞',
        '–≥–æ—Ä—á–∏—Ü–∞', '–ø–∞—Å—Ç–∞ –¥–æ–º–∞—Ç–µ–Ω–∞', '–Ω—É–¥—ä–ª—Å', '—Ñ–∞—Å—É–ª', '–ª–µ—â–∞', '–≥—Ä–∞—Ö',
        'rice', 'pasta', 'oil', 'sugar', 'flour', 'sauce', 'ketchup', 'mayo',
        '–º–µ–¥', '–∫–æ–Ω—Ñ–∏—Ç—é—Ä', '–º–∞—Ä–º–∞–ª–∞–¥', '—Ç–∞—Ö–∞–Ω', '—Ö–∞–ª–≤–∞', '–º–∞—Å–ª–∏–Ω', '–∫–æ—Ä–Ω–∏—à–æ–Ω',
        '—Ä–æ–∑–º–∞—Ä–∏–Ω', '–±–æ—Å–∏–ª–µ–∫', '–∫–æ–ø—ä—Ä', '–º–∞–≥–¥–∞–Ω–æ–∑', '—á–µ—Å—ä–Ω —Å—É—Ö',
    ],
    'food_produce': [
        '—è–±—ä–ª–∫', '–∫—Ä—É—à', '–ø–æ—Ä—Ç–æ–∫–∞–ª', '–±–∞–Ω–∞–Ω', '–≥—Ä–æ–∑–¥–µ', '—è–≥–æ–¥', '–º–∞–ª–∏–Ω',
        '—á–µ—Ä–µ—à', '–ø—Ä–∞—Å–∫–æ–≤–∞', '–∫–∞–π—Å–∏—è', '—Å–ª–∏–≤', '–¥–∏–Ω—è', '–ø—ä–ø–µ—à', '–∫–∏–≤–∏',
        '–º–∞–Ω–≥–æ', '–∞–Ω–∞–Ω–∞—Å', '–ª–∏–º–æ–Ω', '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–∞–≤–æ–∫–∞–¥–æ',
        '–¥–æ–º–∞—Ç', '–∫—Ä–∞—Å—Ç–∞–≤–∏—Ü', '—á—É—à–∫', '–∫–∞—Ä—Ç–æ—Ñ', '–º–æ—Ä–∫–æ–≤', '–ª—É–∫', '—á–µ—Å—ä–Ω',
        '–∑–µ–ª–µ', '—Å–∞–ª–∞—Ç–∞', '—Å–ø–∞–Ω–∞–∫', '—Ç–∏–∫–≤–∏—á–∫', '–ø–∞—Ç–ª–∞–¥–∂–∞–Ω', '–≥—ä–±', '–ø–µ—á—É—Ä–∫',
        'apple', 'banana', 'orange', 'tomato', 'potato', 'carrot', 'onion',
        'fruit', 'vegetable', '–±—Ä–æ–∫–æ–ª–∏', '–∫–∞—Ä—Ñ–∏–æ–ª', '—Ü–µ–ª–∏–Ω', '—Ç–∏–∫–≤–∞',
    ],
    'household': [
        '–ø–æ—á–∏—Å—Ç–≤–∞—â', '–ø—Ä–µ–ø–∞—Ä–∞—Ç', '–ø–µ—Ä–∏–ª–µ–Ω', '–æ–º–µ–∫–æ—Ç–∏—Ç–µ–ª', '–±–µ–ª–∏–Ω–∞', '–≥—ä–±–∞ –∑–∞',
        '–∫—ä—Ä–ø–∞ –ø–æ—á–∏—Å—Ç', '—Ç–æ–∞–ª–µ—Ç–Ω–∞ —Ö–∞—Ä—Ç–∏—è', '–∫—É—Ö–Ω–µ–Ω—Å–∫–∞ —Ö–∞—Ä—Ç–∏—è', '—Å–∞–ª—Ñ–µ—Ç–∫',
        '—Ç–æ—Ä–±', 'cleaning', 'detergent', 'paper towel', 'toilet paper',
        '–º–æ–ø', '–º–µ—Ç–ª–∞', '–ø—Ä–∞—Ö–æ—Å–º—É–∫–∞—á', '–∞—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä', '–æ—Å–≤–µ–∂–∏—Ç–µ–ª',
        '—Å—ä–¥–æ–≤–µ', '–º–∏—è–ª–Ω–∞', '–ø—Ä–∞—Ö –∑–∞ –ø—Ä–∞–Ω–µ', '–≥–µ–ª –∑–∞ –ø—Ä–∞–Ω–µ',
    ],
    'personal_care': [
        '—à–∞–º–ø–æ–∞–Ω', '–±–∞–ª—Å–∞–º –∫–æ—Å–∞', '—Å–∞–ø—É–Ω', '–¥—É—à –≥–µ–ª', '–¥–µ–∑–æ–¥–æ—Ä–∞–Ω—Ç', '–¥–µ–æ', 
        '–ø–∞—Ä—Ñ—é–º', '–∫—Ä–µ–º', '–ª–æ—Å–∏–æ–Ω', '–ø–∞—Å—Ç–∞ –∑–∞ –∑—ä–±–∏', '—á–µ—Ç–∫–∞ –∑–∞ –∑—ä–±–∏', '–±—Ä—ä—Å–Ω–∞—á',
        '–ø–∞–º–ø–µ—Ä—Å', '–¥–∞–º—Å–∫ –ø—Ä–µ–≤—Ä—ä–∑–∫', '—Ç–∞–º–ø–æ–Ω', '–±–æ—è –∑–∞ –∫–æ—Å–∞',
        'shampoo', 'soap', 'deodorant', 'toothpaste', 'cream', 'lotion',
        'cosmetic', '–≥—Ä–∏–º', '—Å–ø–∏—Ä–∞–ª–∞', '—á–µ—Ä–≤–∏–ª–æ', '—Ñ–æ–Ω –¥—å–æ —Ç–µ–Ω', '—Ä–æ–ª-–æ–Ω',
    ],
    'electronics': [
        '–±–∞—Ç–µ—Ä–∏', '–∑–∞—Ä—è–¥–Ω–æ', '–∫–∞–±–µ–ª', '—Å–ª—É—à–∞–ª–∫', '–ª–∞–º–ø–∞ led', '–∫—Ä—É—à–∫–∞',
        '—É–¥—ä–ª–∂–∏—Ç–µ–ª', '—Ä–∞–∑–∫–ª–æ–Ω–∏—Ç–µ–ª', 'battery', 'charger', 'cable',
        'headphone', 'electronic', '—á–∞—Å–æ–≤–Ω–∏–∫', '–∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä', '—Ñ–µ–Ω–µ—Ä',
        '–∞–∫—É–º—É–ª–∞—Ç–æ—Ä', '–º–∏—à–∫–∞', '–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞', 'usb',
    ],
    'home': [
        '—Ç–∞–≤–∞', '—Ç–µ–Ω–¥–∂–µ—Ä', '—á–∞—à–∞', '—á–∏–Ω–∏—è', '–ø—Ä–∏–±–æ—Ä', '—Ä–µ–Ω–¥–µ', '–Ω–æ–∂ –∫—É—Ö–Ω–µ–Ω—Å–∫',
        '–¥—ä—Å–∫–∞', '–∫–∞–Ω–∞', '—Ç–µ—Ä–º–æ—Å', '–≤—ä–∑–≥–ª–∞–≤–Ω–∏—Ü', '–æ–¥–µ—è–ª–æ', '—á–∞—Ä—à–∞—Ñ',
        '–∫—ä—Ä–ø–∞ –±–∞–Ω—è', '–∑–∞–≤–µ—Å', '–∫–∏–ª–∏–º', '–ø–µ—Ä–¥–µ—Ç–∞', '—Ä–∞–º–∫–∞',
        'pan', 'pot', 'cup', 'plate', 'knife', 'kitchen', 'pillow', 'blanket',
        '—Ç–µ—Ä–º–æ–±—É—Ç–∏–ª–∫–∞', '–±—É—Ç–∏–ª–∫–∞ –∑–∞', '—Å—Ç–µ–ª–∞–∂', '–µ—Ç–∞–∂–µ—Ä–∫–∞',
    ],
    'garden': [
        '—Å–∞–∫—Å–∏—è', '—Ü–≤–µ—Ç–µ', '—Ä–∞—Å—Ç–µ–Ω–∏–µ', '–æ—Ä—Ö–∏–¥–µ—è', '—Å–µ–º–µ–Ω–∞', '—Ç–æ—Ä ', '–≥—Ä–∞–¥–∏–Ω',
        '–ª–æ–ø–∞—Ç–∞', '–º–∞—Ä–∫—É—á', 'plant', 'flower', 'garden', 'seed', 'orchid',
        '—Ñ–∞–ª–µ–Ω–æ–ø—Å–∏—Å', '—Ä–æ–∑–∞', '–ª–∞–ª–µ', '—Ç–æ—Ä—Ñ',
    ],
    'clothing': [
        '—Ç–µ–Ω–∏—Å–∫–∞', '—Ä–∏–∑–∞', '–ø–∞–Ω—Ç–∞–ª–æ–Ω', '—Ä–æ–∫–ª—è', '–ø–∏–∂–∞–º–∞', '—á–æ—Ä–∞–ø', '–±–µ–ª—å–æ',
        '—Å—É—Ç–∏–µ–Ω', '—è–∫–µ', '–ø–∞–ª—Ç–æ', '–æ–±—É–≤–∫', '–º–∞—Ä–∞—Ç–æ–Ω–∫', '—á–µ—Ö—ä–ª', '–±–æ–∫—Å–µ—Ä–∫',
        'shirt', 'pants', 'dress', 'shoes', 'jacket', 'socks', 'underwear',
        '—Ç–µ—Ä–º–æ–±–ª—É–∑', '–±–ª—É–∑–∞', '–ø—É–ª–æ–≤–µ—Ä', '–∂–∏–ª–µ—Ç–∫–∞', '–∫–ª–∏–Ω',
    ],
    'pets': [
        '—Ö—Ä–∞–Ω–∞ –∑–∞ –∫–æ—Ç–∫', '—Ö—Ä–∞–Ω–∞ –∑–∞ –∫—É—á', '–∫–æ—Ç–µ—à–∫', '–∫—É—á–µ—à–∫', 'whiskas',
        'pedigree', '–ª–∞–∫–æ–º—Å—Ç–≤ –∑–∞ –∫–æ—Ç–∫', '–ª–∞–∫–æ–º—Å—Ç–≤ –∑–∞ –∫—É—á',
        'pet food', 'cat food', 'dog food',
        'felix', 'sheba', 'royal canin', 'purina',
    ],
}

# Compile patterns
COMPILED_PATTERNS = {}
for category, keywords in CATEGORY_PATTERNS.items():
    escaped = [re.escape(kw) for kw in keywords]
    pattern = r'(' + '|'.join(escaped) + r')'
    COMPILED_PATTERNS[category] = re.compile(pattern, re.IGNORECASE)


def classify_product(name: str) -> Tuple[str, float]:
    """Classify a product name into a category."""
    if not name:
        return ('other', 0.0)
    
    name_lower = name.lower()
    
    matches = []
    for category, pattern in COMPILED_PATTERNS.items():
        found = pattern.findall(name_lower)
        if found:
            confidence = min(1.0, len(found) * 0.3 + 0.5)
            matches.append((category, confidence, len(found)))
    
    if not matches:
        return ('other', 0.0)
    
    matches.sort(key=lambda x: (x[2], x[1]), reverse=True)
    return (matches[0][0], matches[0][1])


def categories_compatible(cat1: str, cat2: str) -> bool:
    """Check if two categories are compatible for matching."""
    if cat1 == cat2:
        return True
    if cat1 == 'other' or cat2 == 'other':
        return True
    # Different categories = not compatible
    return False


def get_category_display(category: str) -> str:
    """Human-readable category name."""
    names = {
        'food_dairy': 'ü•õ Dairy',
        'food_meat': 'ü•© Meat & Fish',
        'food_bakery': 'üçû Bakery',
        'food_drinks': 'ü•§ Drinks',
        'food_snacks': 'üç´ Snacks',
        'food_frozen': 'üßä Frozen',
        'food_pantry': 'ü´ô Pantry',
        'food_produce': 'ü•¨ Produce',
        'household': 'üßπ Household',
        'personal_care': 'üß¥ Personal Care',
        'electronics': 'üîå Electronics',
        'home': 'üè† Home',
        'garden': 'üå± Garden',
        'clothing': 'üëï Clothing',
        'pets': 'üê± Pets',
        'other': '‚ùì Other',
    }
    return names.get(category, category)


if __name__ == '__main__':
    # Test the worst matches from the audit
    bad_matches = [
        ("BRIO –¢–µ—Ä–º–æ–±—É—Ç–∏–ª–∫–∞", "–¢–µ—Ä–º–æ–±–ª—É–∑–∏"),
        ("–¢–æ—Ä—Ç–∞ –°–∞—Ö–µ—Ä", "–¢–æ—Ä—Ç–∏–ª–∞ –ø–∏—Ç–∫–∏"),
        ("–ú–æ–ø —Ç–∏–ø –ü–µ–ø–µ—Ä—É–¥–∞", "–ë–µ–π–±–∏ –ø–µ–ø–µ—Ä–æ–Ω–∏"),
        ("–ö—ä–ø–∞–Ω–∏ –∫–æ—Ä–∏", "–î—É—à –≥–µ–ª"),
        ("Plomari –£–∑–æ", "–ì–æ—Ñ—Ä–µ—Ç–∏"),
        ("–ö—Ä—É—à–∏ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Å", "–°—É—Ç–∏–µ–Ω"),
        ("–§–∏–ª–µ –ï–ª–µ–Ω–∞", "–î–µ–æ —Ä–æ–ª-–æ–Ω"),
        ("Krina –û—Ä–∏–∑", "–û—Ä–∏–∑–æ–≤–∏ –≤–∞—Ñ–ª–∏"),
        ("–ó–∞–≥–æ—Ä–∫–∞ –ë–∏—Ä–∞", "–ë–∏—Ä–∞ –ì–æ–ª–¥"),  # SHOULD match
        ("Coca-Cola", "Coca-Cola –≥–∞–∑–∏—Ä–∞–Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞"),  # SHOULD match
        ("Whiskas –°—É—Ö–∞ —Ö—Ä–∞–Ω–∞", "–°—É—Ö–∞ —Ö—Ä–∞–Ω–∞ –∑–∞ –∫–æ—Ç–∫–∏"),  # SHOULD match
        ("–ì—ä–±–∏ –ø–µ—á—É—Ä–∫–∏", "–ö—Ä–∞–ª—Å–∫–∏ –ø–µ—á—É—Ä–∫–∏"),  # SHOULD match
    ]
    
    print("=== CATEGORY FILTER TEST ===\n")
    blocked = 0
    allowed = 0
    for name1, name2 in bad_matches:
        cat1, _ = classify_product(name1)
        cat2, _ = classify_product(name2)
        compat = categories_compatible(cat1, cat2)
        status = "‚úì ALLOW" if compat else "‚úó BLOCK"
        if compat:
            allowed += 1
        else:
            blocked += 1
        c1 = get_category_display(cat1)
        c2 = get_category_display(cat2)
        print(f"  {status} | {name1[:22]:22} {c1:15} vs {name2[:22]:22} {c2}")
    
    print(f"\n  Blocked: {blocked} | Allowed: {allowed}")
