<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromoBG - –°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω–∏—Ç–µ –≤ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–∏—Ç–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://images.openfoodfacts.org">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --accent: #f59e0b;
            --bg-light: #f9fafb;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            min-height: 100vh;
        }
        
        .product-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 40px -10px rgba(16, 185, 129, 0.3);
        }
        
        .discount-badge { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }
        
        .nutriscore-a { background: #038141; }
        .nutriscore-b { background: #85bb2f; }
        .nutriscore-c { background: #fecb02; color: #333 !important; }
        .nutriscore-d { background: #ee8100; }
        .nutriscore-e { background: #e63e11; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .typeahead { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 300px; overflow-y: auto; z-index: 50; }
        .typeahead-item { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; transition: background 0.15s; }
        .typeahead-item:hover { background: #ecfdf5; }
        
        .store-btn {
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .store-btn:hover {
            transform: translateY(-2px);
        }
        
        .store-btn.active {
            border-color: var(--primary);
            background: #ecfdf5;
        }
        
        .price-compare-card {
            transition: all 0.2s ease;
        }
        
        .price-compare-card:hover {
            transform: scale(1.02);
        }
        
        .best-price {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
        }
        
        .match-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        /* Mobile-first responsive */
        @media (max-width: 640px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .store-filters {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .store-btn {
                flex-shrink: 0;
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        @media (min-width: 640px) {
            .results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .results-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-gray-100">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üõí</span>
                    <h1 class="text-2xl font-bold" style="background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        PromoBG
                    </h1>
                </div>
                <p class="text-sm text-gray-500 hidden sm:block">–°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω–∏—Ç–µ ‚Ä¢ –°–ø–µ—Å—Ç–∏ –ø–∞—Ä–∏</p>
            </div>
        </div>
    </header>

    <!-- Search Section -->
    <section class="bg-white py-8 sm:py-12 shadow-sm">
        <div class="max-w-3xl mx-auto px-4">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-gray-800">
                –ù–∞–º–µ—Ä–∏ –Ω–∞–π-–¥–æ–±—Ä–∏—Ç–µ –æ—Ñ–µ—Ä—Ç–∏ üè∑Ô∏è
            </h2>
            
            <!-- Search Input -->
            <div class="relative mb-4">
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            placeholder="–¢—ä—Ä—Å–∏ –ø—Ä–æ–¥—É–∫—Ç... ( –Ω–∞–ø—Ä. –º–ª—è–∫–æ, —Ö–ª—è–±, –∫–∞—Ñ–µ)"
                            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none transition text-base"
                            autocomplete="off"
                        >
                        <div id="typeahead" class="typeahead hidden"></div>
                    </div>
                    <button 
                        onclick="searchProducts()"
                        class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition shadow-lg shadow-green-500/25"
                    >
                        –¢—ä—Ä—Å–∏
                    </button>
                </div>
            </div>
            
            <!-- Store Filter Buttons -->
            <div class="store-filters flex gap-2 flex-wrap mb-4">
                <button onclick="setStoreFilter('')" id="storeBtnAll" class="store-btn active bg-white px-4 py-2 rounded-xl font-medium border-2 border-gray-200 text-gray-700">
                    –í—Å–∏—á–∫–∏ <span id="storeCountAll" class="font-bold text-green-600">-</span>
                </button>
                <button onclick="setStoreFilter('Kaufland')" id="storeBtnKaufland" class="store-btn bg-yellow-50 px-4 py-2 rounded-xl font-medium border-2 border-yellow-200 text-gray-700">
                    üü° Kaufland <span id="storeCountKaufland" class="font-bold">-</span>
                </button>
                <button onclick="setStoreFilter('Lidl')" id="storeBtnLidl" class="store-btn bg-blue-50 px-4 py-2 rounded-xl font-medium border-2 border-blue-200 text-gray-700">
                    üîµ Lidl <span id="storeCountLidl" class="font-bold">-</span>
                </button>
                <button onclick="setStoreFilter('Billa')" id="storeBtnBilla" class="store-btn bg-green-50 px-4 py-2 rounded-xl font-medium border-2 border-green-200 text-gray-700">
                    üü¢ Billa <span id="storeCountBilla" class="font-bold">-</span>
                </button>
            </div>
            
            <!-- Other Filters -->
            <div class="flex gap-3 flex-wrap items-center">
                <select id="discountFilter" class="px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:outline-none text-sm" onchange="filterProducts()">
                    <option value="0">üí∞ –í—Å–∏—á–∫–∏ –æ—Ñ–µ—Ä—Ç–∏</option>
                    <option value="20">–ù–∞–¥ 20% –æ—Ç—Å—Ç—ä–ø–∫–∞</option>
                    <option value="40">–ù–∞–¥ 40% –æ—Ç—Å—Ç—ä–ø–∫–∞</option>
                    <option value="50">–ù–∞–¥ 50% –æ—Ç—Å—Ç—ä–ø–∫–∞</option>
                </select>
                <label class="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border-2 border-gray-200 cursor-pointer hover:bg-gray-50 transition">
                    <input type="checkbox" id="crossStoreFilter" onchange="filterProducts()" class="w-4 h-4 text-green-500 rounded">
                    <span class="text-sm font-medium">üîó –°–∞–º–æ –∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</span>
                </label>
            </div>
        </div>
    </section>

    <!-- Stats -->
    <section class="max-w-6xl mx-auto px-4 py-6">
        <div class="grid grid-cols-3 gap-3 sm:gap-4 text-center">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-2xl sm:text-3xl font-bold text-green-500" id="totalProducts">-</div>
                <div class="text-xs sm:text-sm text-gray-500 mt-1">–ü—Ä–æ–¥—É–∫—Ç–∏</div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-2xl sm:text-3xl font-bold text-blue-500" id="crossStoreCount">-</div>
                <div class="text-xs sm:text-sm text-gray-500 mt-1">–ó–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-2xl sm:text-3xl font-bold text-orange-500" id="avgDiscount">-</div>
                <div class="text-xs sm:text-sm text-gray-500 mt-1">–°—Ä–µ–¥–Ω–∞ –æ—Ç—Å—Ç—ä–ø–∫–∞</div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-400 mt-3" id="lastUpdated"></p>
    </section>

    <!-- Results -->
    <section class="max-w-6xl mx-auto px-4 pb-12">
        <h3 class="text-xl font-semibold mb-4 text-gray-800" id="resultsTitle">üî• –¢–æ–ø –æ—Ñ–µ—Ä—Ç–∏</h3>
        <div id="results" class="results-grid">
            <div class="text-center py-12 text-gray-400 col-span-full">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
        </div>
    </section>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[85vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <div>
                    <h3 class="font-bold text-lg text-gray-800" id="modalTitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ü–µ–Ω–∏</h3>
                    <p class="text-sm text-green-600 font-medium" id="matchType">üí∞ Price Match</p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition">&times;</button>
            </div>
            <div id="modalContent" class="p-4"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-auto">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-300">PromoBG ¬© 2026 ‚Ä¢ –î–∞–Ω–Ω–∏—Ç–µ —Å–µ –æ–±–Ω–æ–≤—è–≤–∞—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</p>
            <p class="text-sm text-gray-500 mt-2">üü° Kaufland ‚Ä¢ üîµ Lidl ‚Ä¢ üü¢ Billa</p>
        </div>
    </footer>

    <script>
        let data = { products: [], off: {}, groups: {}, meta: {} };
        let searchIndex = [];
        let currentStoreFilter = '';
        
        // Store counts
        const storeCounts = { all: 0, Kaufland: 0, Lidl: 0, Billa: 0 };
        
        // Store-specific suffixes to strip from display names
        const STORE_SUFFIXES = [
            /–æ—Ç\s*—Å–≤–µ–∂–∞—Ç–∞\s*–≤–∏—Ç—Ä–∏–Ω–∞/gi,
            /–æ—Ç\s*–Ω–∞—à–∞—Ç–∞\s*–ø–µ–∫–∞—Ä–Ω–∞/gi,
            /–æ—Ç\s*–¥–µ–ª–∏–∫–∞—Ç–µ—Å–Ω–∞—Ç–∞\s*–≤–∏—Ç—Ä–∏–Ω–∞/gi,
            /–ó–∞\s*1\s*–∫–≥/gi,
            /\d+\s*–±—Ä\.?\s*$/gi,
            /\d+-\d+\*?/gi,
            /—Ä–∞–∑–ª–∏—á–Ω–∏\s*–≤–∏–¥–æ–≤–µ?/gi,
        ];
        
        // Clean product name for display
        function cleanProductName(name) {
            if (!name) return '';
            let cleaned = name.replace(/\n/g, ' ');
            STORE_SUFFIXES.forEach(pattern => {
                cleaned = cleaned.replace(pattern, ' ');
            });
            return cleaned.trim().replace(/\s+/g, ' ');
        }
        
        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('data/products.json');
                data = await response.json();
                buildSearchIndex();
                calculateStoreCounts();
                updateStats(data.products);
                updateStoreButtons();
                showTopDeals();
            } catch (err) {
                console.error('Error loading products:', err);
                document.getElementById('results').innerHTML = 
                    '<div class="text-center py-12 text-red-500 col-span-full">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏—Ç–µ</div>';
            }
        }
        
        function calculateStoreCounts() {
            storeCounts.all = data.products.length;
            storeCounts.Kaufland = data.products.filter(p => p.store === 'Kaufland').length;
            storeCounts.Lidl = data.products.filter(p => p.store === 'Lidl').length;
            storeCounts.Billa = data.products.filter(p => p.store === 'Billa').length;
        }
        
        function updateStoreButtons() {
            document.getElementById('storeCountAll').textContent = '(' + storeCounts.all + ')';
            document.getElementById('storeCountKaufland').textContent = '(' + storeCounts.Kaufland + ')';
            document.getElementById('storeCountLidl').textContent = '(' + storeCounts.Lidl + ')';
            document.getElementById('storeCountBilla').textContent = '(' + storeCounts.Billa + ')';
        }
        
        function setStoreFilter(store) {
            currentStoreFilter = store;
            document.querySelectorAll('.store-btn').forEach(btn => btn.classList.remove('active'));
            if (store === '') {
                document.getElementById('storeBtnAll').classList.add('active');
            } else {
                const btn = document.getElementById('storeBtn' + store);
                if (btn) btn.classList.add('active');
            }
            filterProducts();
        }
        
        function buildSearchIndex() {
            const names = new Set();
            data.products.forEach(p => {
                const cleanedName = cleanProductName(p.name);
                const words = cleanedName.split(/\s+/).slice(0, 3).join(' ');
                if (words.length > 2) names.add(words);
            });
            searchIndex = Array.from(names).sort();
        }
        
        function getNutriscore(product) {
            if (!product.off_barcode || !data.off[product.off_barcode]) return null;
            return data.off[product.off_barcode].nutriscore?.toLowerCase();
        }
        
        function getGroupProducts(groupId) {
            if (!groupId) return [];
            return data.products.filter(p => p.group_id === groupId);
        }
        
        // Check if a product has a valid cross-store comparison (2+ products in 2+ stores)
        function hasValidComparison(product) {
            if (!product.group_id) return false;
            const groupProducts = getGroupProducts(product.group_id);
            if (groupProducts.length < 2) return false;
            const uniqueStores = new Set(groupProducts.map(p => p.store));
            return uniqueStores.size >= 2;
        }
        
        function showTopDeals() {
            const matchedProducts = data.products.filter(p => hasValidComparison(p));
            
            if (matchedProducts.length > 0) {
                matchedProducts.sort((a, b) => {
                    const groupA = data.groups[a.group_id];
                    const groupB = data.groups[b.group_id];
                    return (groupB?.savings || 0) - (groupA?.savings || 0);
                });
                renderProducts(matchedProducts.slice(0, 40));
                
                const validGroups = new Set(matchedProducts.map(p => p.group_id));
                document.getElementById('resultsTitle').textContent = 
                    'üí∞ –°—Ä–∞–≤–Ω–∏ —Ü–µ–Ω–∏—Ç–µ (' + validGroups.size + ' —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è)';
            } else {
                renderProducts(data.products.slice(0, 20));
                document.getElementById('resultsTitle').textContent = 'üõí –í—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏';
            }
        }
        
        function searchProducts() {
            hideTypeahead();
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!query) {
                showTopDeals();
                return;
            }
            
            let results = data.products.filter(p => {
                const cleanedName = cleanProductName(p.name).toLowerCase();
                return cleanedName.includes(query) || p.name.toLowerCase().includes(query);
            });
            results = applyFilters(results);
            renderProducts(results.slice(0, 100));
            document.getElementById('resultsTitle').textContent = 
                '–†–µ–∑—É–ª—Ç–∞—Ç–∏ –∑–∞ "' + query + '" (' + results.length + ')';
        }
        
        function filterProducts() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (query) {
                searchProducts();
            } else {
                let results = applyFilters(data.products);
                renderProducts(results.slice(0, 40));
                
                if (currentStoreFilter) {
                    document.getElementById('resultsTitle').textContent = 'üõí ' + currentStoreFilter + ' (' + results.length + ')';
                } else if (document.getElementById('crossStoreFilter').checked) {
                    document.getElementById('resultsTitle').textContent = 'üîó –ó–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (' + results.length + ')';
                } else {
                    document.getElementById('resultsTitle').textContent = 'üî• –¢–æ–ø –æ—Ñ–µ—Ä—Ç–∏';
                }
            }
            
            updateFilteredStoreCounts();
            updateStats(applyFilters(data.products));
        }
        
        function updateFilteredStoreCounts() {
            const minDiscount = parseInt(document.getElementById('discountFilter').value) || 0;
            const crossStoreOnly = document.getElementById('crossStoreFilter').checked;
            
            const filtered = data.products.filter(p => {
                if (currentStoreFilter && p.store !== currentStoreFilter) return false;
                if (minDiscount && (p.discount_pct || 0) < minDiscount) return false;
                if (crossStoreOnly && !hasValidComparison(p)) return false;
                return true;
            });
            
            document.getElementById('storeCountAll').textContent = '(' + filtered.length + ')';
            
            const filteredByStore = {
                'Kaufland': filtered.filter(p => p.store === 'Kaufland').length,
                'Lidl': filtered.filter(p => p.store === 'Lidl').length,
                'Billa': filtered.filter(p => p.store === 'Billa').length
            };
            
            document.getElementById('storeCountKaufland').textContent = '(' + filteredByStore.Kaufland + ')';
            document.getElementById('storeCountLidl').textContent = '(' + filteredByStore.Lidl + ')';
            document.getElementById('storeCountBilla').textContent = '(' + filteredByStore.Billa + ')';
        }

        function updateStats(filteredProducts) {
            document.getElementById('totalProducts').textContent = filteredProducts.length.toLocaleString();
            
            const crossStoreGroups = new Set();
            filteredProducts.forEach(p => {
                if (hasValidComparison(p)) {
                    crossStoreGroups.add(p.group_id);
                }
            });
            document.getElementById('crossStoreCount').textContent = crossStoreGroups.size.toLocaleString();
            
            const withDiscount = filteredProducts.filter(p => p.discount_pct && p.discount_pct > 0);
            const avgDiscount = withDiscount.length > 0 
                ? Math.round(withDiscount.reduce((sum, p) => sum + p.discount_pct, 0) / withDiscount.length)
                : 0;
            document.getElementById('avgDiscount').textContent = avgDiscount + '%';
            
            if (data.meta.updated_at) {
                const date = new Date(data.meta.updated_at);
                document.getElementById('lastUpdated').textContent = 
                    '–ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è: ' + date.toLocaleDateString('bg-BG') + ' ' + date.toLocaleTimeString('bg-BG', {hour: '2-digit', minute: '2-digit'});
            }
        }

        
        function applyFilters(products) {
            const store = currentStoreFilter;
            const minDiscount = parseInt(document.getElementById('discountFilter').value) || 0;
            const crossStoreOnly = document.getElementById('crossStoreFilter').checked;
            
            return products.filter(p => {
                if (store && p.store !== store) return false;
                if (minDiscount && (p.discount_pct || 0) < minDiscount) return false;
                if (crossStoreOnly && !hasValidComparison(p)) return false;
                return true;
            });
        }
        
        function renderProducts(products) {
            const container = document.getElementById('results');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400 col-span-full">–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</div>';
                return;
            }
            
            container.innerHTML = products.map(p => {
                const nutriscore = getNutriscore(p);
                const hasComparison = hasValidComparison(p);
                const displayName = cleanProductName(p.name);
                
                return '<div class="product-card bg-white rounded-2xl shadow-sm overflow-hidden transition-all duration-200 hover:shadow-lg ' + (hasComparison ? 'cursor-pointer' : '') + '" onclick="' + (hasComparison ? "showComparison('" + p.group_id + "')" : '') + '">' +
                    '<div class="relative">' +
                        (p.discount_pct ? '<div class="discount-badge absolute top-2 right-2 text-white text-sm font-bold px-3 py-1 rounded-full shadow-lg">-' + p.discount_pct + '%</div>' : '') +
                        (nutriscore ? '<div class="absolute top-2 left-2 nutriscore-' + nutriscore + ' text-white text-xs font-bold px-2 py-1 rounded-lg uppercase">' + nutriscore + '</div>' : '') +
                        (hasComparison ? '<div class="absolute bottom-2 left-2 match-badge text-white text-xs font-bold px-2 py-1 rounded-full">üîó –°—Ä–∞–≤–Ω–∏</div>' : '') +
                        '<div class="h-28 sm:h-32 bg-gray-50 flex items-center justify-center text-4xl">' + getStoreEmoji(p.store) + '</div>' +
                    '</div>' +
                    '<div class="p-3 sm:p-4">' +
                        '<div class="text-xs text-gray-400 mb-1">' + p.store + '</div>' +
                        '<h4 class="font-semibold text-sm leading-tight mb-2 line-clamp-2" title="' + displayName + '">' + displayName.slice(0, 45) + (displayName.length > 45 ? '...' : '') + '</h4>' +
                        '<div class="flex items-baseline gap-2">' +
                            '<span class="' + (p.price > 99 ? 'text-base' : 'text-xl') + ' font-bold text-green-600">' + (p.price?.toFixed(2) || '-') + '–ª–≤</span>' +
                            (p.old_price ? '<span class="text-sm text-gray-400 line-through">' + p.old_price.toFixed(2) + '–ª–≤</span>' : '') +
                        '</div>' +
                        (p.price_per_kg || p.price_per_l ? '<div class="text-xs text-gray-500 mt-1">' + (p.price_per_kg ? p.price_per_kg.toFixed(2) + '–ª–≤/–∫–≥' : '') + (p.price_per_l ? p.price_per_l.toFixed(2) + '–ª–≤/–ª' : '') + '</div>' : '') +
                        (hasComparison ? '<div class="mt-3 w-full text-center text-xs bg-green-50 text-green-600 py-2 rounded-lg font-medium">üìä –í–∏–∂ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ—Ç–æ</div>' : '') +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        function showComparison(groupId) {
            const group = data.groups[groupId];
            if (!group) return;
            
            const allProducts = getGroupProducts(groupId);
            const byStore = {};
            allProducts.forEach(p => {
                if (!byStore[p.store] || p.price < byStore[p.store].price) {
                    byStore[p.store] = p;
                }
            });
            const products = Object.values(byStore).sort((a, b) => (a.price || 999) - (b.price || 999));
            
            if (products.length < 2) return;
            
            const offData = data.off[group.off_barcode];
            const minPrice = Math.min(...products.map(p => p.price || 999));
            const maxPrice = Math.max(...products.map(p => p.price || 0));
            const savings = maxPrice - minPrice;
            const savingsPct = Math.round(savings / maxPrice * 100);
            
            const modalTitle = offData?.name || cleanProductName(products[0]?.name) || '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ';
            document.getElementById('modalTitle').textContent = modalTitle;
            
            const isPriceMatch = savings <= 0.01;
            const isCrossStore = products.length >= 2;
            if (isPriceMatch && isCrossStore) {
                document.getElementById('matchType').innerHTML = 'üí∞ <strong>–¶–µ–Ω–∏—Ç–µ —Å—ä–≤–ø–∞–¥–∞—Ç!</strong> ‚Äî –ò–∑–±–µ—Ä–∏ —É–¥–æ–±–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω';
            } else if (isCrossStore) {
                document.getElementById('matchType').innerHTML = 'üè∑Ô∏è <strong>–ò–º–∞ —Ä–∞–∑–ª–∏–∫–∞!</strong> ‚Äî –°–ø–µ—Å—Ç–∏ –æ—Ç –ø–æ-–µ–≤—Ç–∏–Ω–∏—è';
            } else {
                document.getElementById('matchType').innerHTML = 'üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ü–µ–Ω–∏';
            }
            
            document.getElementById('modalContent').innerHTML = 
                (offData?.nutriscore ? '<div class="mb-4 flex items-center gap-2"><span class="nutriscore-' + offData.nutriscore.toLowerCase() + ' text-white px-3 py-1 rounded-lg font-bold uppercase">Nutriscore ' + offData.nutriscore + '</span><span class="text-sm text-gray-500">' + (offData.brand || '') + '</span></div>' : '') +
                '<div class="space-y-3">' +
                    products.map((p, i) => {
                        const isPM = savings <= 0.01;
                        const isBest = i === 0 && !isPM;
                        const cleanedName = cleanProductName(p.name);
                        return '<div class="price-compare-card flex items-center gap-3 p-4 rounded-xl ' + (isBest ? 'best-price' : isPM ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50 border border-gray-100') + '">' +
                            '<span class="text-3xl">' + getStoreEmoji(p.store) + '</span>' +
                            '<div class="flex-1">' +
                                '<div class="font-semibold text-gray-800">' + p.store + '</div>' +
                                '<div class="text-xs text-gray-500 truncate" title="' + cleanedName + '">' + cleanedName.slice(0, 35) + (cleanedName.length > 35 ? '...' : '') + '</div>' +
                                '<div class="text-xs text-gray-400">' + (p.price_per_kg ? 'üì¶ ' + p.price_per_kg.toFixed(2) + '–ª–≤/–∫–≥' : '') + (p.price_per_l ? 'üì¶ ' + p.price_per_l.toFixed(2) + '–ª–≤/–ª' : '') + '</div>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<div class="text-xl font-bold ' + (isBest ? 'text-green-600' : isPM ? 'text-blue-600' : 'text-gray-700') + '">' + (p.price?.toFixed(2) || '-') + '–ª–≤</div>' +
                                (isBest ? '<div class="text-xs text-green-600 font-bold">‚úÖ –ù–ê–ô-–î–û–ë–†–ê –¶–ï–ù–ê</div>' : '') +
                                (isPM ? '<div class="text-xs text-blue-600 font-bold">üí∞ –ï–î–ù–ê–ö–í–ê –¶–ï–ù–ê</div>' : '') +
                            '</div>' +
                        '</div>';
                    }).join('') +
                '</div>' +
                (savings > 0.01 ? '<div class="mt-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl text-center border border-green-100"><span class="text-green-800 font-bold text-lg">üí∞ –°–ø–µ—Å—Ç—è–≤–∞—à ' + savings.toFixed(2) + '–ª–≤ (' + savingsPct + '%)</span><p class="text-sm text-green-600 mt-1">–ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞ –æ—Ç –Ω–∞–π-–µ–≤—Ç–∏–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω</p></div>' : '') +
                '<button onclick="closeModal()" class="mt-4 w-full py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl transition">–ó–∞—Ç–≤–æ—Ä–∏</button>';
            document.getElementById('comparisonModal').classList.add('active');
        }
        
        function closeModal(event) {
            if (!event || event.target.id === 'comparisonModal') {
                document.getElementById('comparisonModal').classList.remove('active');
            }
        }
        
        function getStoreEmoji(store) {
            const emojis = { 'Kaufland': 'üü°', 'Lidl': 'üîµ', 'Billa': 'üü¢' };
            return emojis[store] || 'üõí';
        }
        
        function showTypeahead(query) {
            if (!query || query.length < 2) { hideTypeahead(); return; }
            const matches = searchIndex.filter(name => name.toLowerCase().includes(query.toLowerCase())).slice(0, 8);
            if (matches.length === 0) { hideTypeahead(); return; }
            const container = document.getElementById('typeahead');
            container.innerHTML = matches.map(m => '<div class="typeahead-item" onclick="selectTypeahead(\'' + m.replace(/'/g, "\\'") + '\')">üîç ' + m + '</div>').join('');
            container.classList.remove('hidden');
        }
        
        function hideTypeahead() { document.getElementById('typeahead').classList.add('hidden'); }
        
        function selectTypeahead(value) {
            document.getElementById('searchInput').value = value;
            hideTypeahead();
            searchProducts();
        }
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { hideTypeahead(); searchProducts(); } });
        document.getElementById('searchInput').addEventListener('input', (e) => { showTypeahead(e.target.value); });
        document.getElementById('searchInput').addEventListener('blur', () => { setTimeout(hideTypeahead, 200); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        
        loadProducts();
    </script>
</body>
</html>
